* 为什么IP可用来定位，MAC却不可以？

http://zhangshen147.online/post/mac-truth

** 引言

我们经常会在新闻中看到一些公安部门利用IP地址追踪嫌疑人的相关报道，IP地址可以用于实现定位与追踪功能是由于它自身的一些特性所决定的，IP地址由运营商负责发放并完成相关信息的备案，导致IP地址与用户所在地理位置之间的关联性较强，从而可以实现追踪。

假设我们正在追踪一名没有任何计算机背景的嫌疑人的话，由于他不懂得利用“跳板”等途径来抹除自己的地理位置信息，因此我们只需要守株待兔，等他使用了互联网以后就可以比较轻松地追踪到他们了（不能实现精准定位，只能确定一个大概的活动范围）。

问题已经初步得到了解决，可在知乎上看到了这样一个问题以后：为什么根据 IP 地址查询物理所在地，而不是 mac 地址？某位大神的回答让我意识到了自己原来的认知是很有问题的，既不全面的也不细节，可谓山外青山楼外楼啊，学习不能固步自封，要时刻保持格物致知的精神。

** MAC地址并不保证全球唯一

MAC地址（Media Access Control Address），中文译作媒体访问控制地址，也称为局域网地址（LAN Address）、以太网地址（Ethernet Address）或物理地址（Physical Address），它是一个用来确认网络设备位置的地址。在OSI模型中，第三层网络层负责IP地址，第二层数据链接层则负责MAC地址。MAC地址用于在网络中唯一标识一张网卡，一台设备若有多张网卡，则每个网卡都需要并会有一个唯一的MAC地址。

摘自《维基百科》

我感觉这个说法是有问题的，事实上MAC地址虽然用于在网络中标识一张网卡，但并不一定就能唯一地标识一张网卡，因为MAC地址是可以被修改、被伪造的，虽然可能好多人不知道，但事实正是如此。

如果把网卡比作一群孩子的话，那么MAC地址就是孩子们的名字，这些孩子生来就被造物主赋予了一个独一无二、互不重复的名字，以确保造物主可以通过姓名来辨识这些孩子们。

可问题在于造物主的精力也是有限的，他无法一直看着孩子们、阻止孩子们为自己起一个新的名字，一旦孩子们修改了自己的名字以后，造物主原本搭建起来的整个标识系统就开始失效和走向崩溃了。除此之外，修改姓名的孩子数量越多，整个系统就会变得愈发不可用，造物主再也无法方便地分辨出这些孩子们了，可谓一切努力付之一炬。

MAC地址也面临着同样的情况，虽然网卡厂商会在机构的管理下保证自家网卡MAC地址的唯一性，但却阻止不了用户自己去修改MAC地址，因此“MAC地址全球唯一”是个假命题。

** 如何修改MAC地址？

每张网卡对应一个MAC地址，且这个MAC地址是烧录在EPROM/EEPROM中的，一般来说不允许普通用户修改，不过我们可以通过一些其它途径来修改它，还有些厂商会直接提供配套的程序来帮助我们修改它，这个存储于ROM之中的MAC地址，我们称之为真实MAC地址。

可进程是动态的概念，在ROM中存储的数据需要被加载到内存以后才能真正发挥作用，对于真实MAC地址来说，它真正发挥作用的时间点是在加载到操作系统的ARP缓存表中以后的，这个加载于内存之中的MAC地址，我们称之为虚拟MAC地址。

修改MAC地址的方式分为两种：修改虚拟的MAC地址和修改真实的MAC地址，其中修改虚拟的MAC地址很简单，使用这个命令即可：

$ sudo ifconfig en0 ether 88:88:88:88:88:88
再次使用ifconfig命令查看网卡信息，可以看到我的en0网卡的MAC地址已经被成功修改为了比较炫酷的88:88:88:88:88:88：

[[./img/mac_truth_mac_address.png]]

不过需要注意的是，我们这里修改的是虚拟的MAC地址，也就是内存中临时存在的一份拷贝，每当机器重启，内存就又会从ROM里读出原本的MAC地址了，MAC地址也就被重置了，所以说这种方法是治标不治本的。

如果想永久地修改本机的MAC地址，也就是修改真实MAC地址的话，我们需要用到厂家提供的一些辅助程序来达到目的，这个我没具体试过，就不再赘述了。不过无论是修改虚拟MAC地址，还是真实MAC地址，都指向了一个很明显的事实：MAC地址是可以被修改的！

MAC地址在将来还有可能被复用
除此之外，MAC地址在将来还有可能被复用，这是MAC地址并不保证全球唯一的另一个原因，但只作为理解补充，并非主要因素，而且现在的MAC地址空间距离耗尽还有一段时间，还不需要借助“复用”来缓解剩余地址空间压力的地步。。

首先了解一下MAC地址的构成：MAC地址共有48位，可划分为6个字节。其中前3个字节是组织唯一标志符OUI，由IEEE的注册管理机构负责分配给不同的厂商。后3个字节是获得OUI的厂商可以自行分配的、用来标记不同网卡的网络接口标识符。


如果仅仅将目光局限在本地单播MAC地址的话，那么计算可用地址数量的时候，要去掉第一个字节的低两位，因为它们是用来表示地址类型的。也就是说可用的MAC地址有246 = 70 3687 4417 7664个，翻译过来大概是70万亿，但是每个厂商一次分配就要拿走224个地址，如果用不完的话就会很浪费，而每年智能手机（智能手机按道理来讲是不允许MAC地址重复的，因为它是可移动的，和呆在屋里不动弹的台式主机情况不同）、路由器等设备对MAC地址的消耗量是极大的，这样看来，虽然还比较遥远，但MAC地址终有耗尽的那一天。

MAC地址耗尽以后就必须要像ipv4那样升级到ipv6吗？不用，因为它俩走的本来就不是一条路，IP地址需要保证它在全球范围内的唯一性，而MAC地址则无需保证它在全球范围内的唯一性，它只需要具备在同一通信域内的唯一性就ok了。为什么呢？因为MAC地址工作在数据链路层，被存储在MAC帧的首部，出了路由器以后MAC地址就消失不见了，并不需要和全球所有的MAC地址碰面。所以说只要保证同一局域网内主机间的MAC地址不重复就OK了。

因此，当MAC地址耗尽以后，厂商完全可以选择把之前用过的MAC地址再拿出来复用（这个机制和TCP协议中的序列号很类似，可以类比理解），因为MAC地址会随着电子设备生命周期的耗尽而消失。很长时间过去了，之前占着这个MAC地址的设备一般来说都已经报废了，就算退一万步来说没报废吧，那新设备和旧设备又在同一个通信域内碰面的概率也是非常小的。

** 为什么要保证初始MAC地址唯一？


问题基本上已经豁然开朗了，但还有一点困惑：既然MAC地址都出不了数据链路层，只需要保证在局域网内不重复就行了，那为什么IEEE还要花大功夫去制定标准，去管理它呢？

我认为是这样的：如果厂商在出厂网卡的时候都是随机写入MAC地址的，甚至更过分的话会直接把一整批的网卡都设置成相同的MAC地址，这样下去用户买到的机器具有相同的MAC地址的几率就会增大，相应的在同一个局域网内发生地址碰撞的几率也会增大，而用户作为非专业人士，无法自行解决这个问题的话会非常影响用户体验（其实许多学CS的估计都不能解决这个问题吧）。

为了彻底消除掉这种不良的影响，IEEE和网卡厂商们尽量在出厂阶段就为我们解决掉了这一问题，只要保证了MAC地址的全球唯一性，那么作为它的子集，保证MAC地址在局域网内的唯一性也就顺理成章了，可以完全消除掉地址撞车的可能性，如果一名用户非要去修改自己本机的MAC地址的话，那说明他一定是具备一定的计算机知识储备的，他也应该对自己的行为负责，改错了弄不回来的话也只能怪自己学艺不精了，怨不得别人。

** MAC地址无法与地理位置相关联

MAC地址自出厂以后就被固化在网卡之中，而网卡一般都搭载在个人主机上。现在我们想要建立起一张MAC地址与主机所处地理位置之间的映射表的话，只能通过主机销售商这一层来获取。且不论主机销售商是否有权利向用户索取隐私信息，就算主机销售商能把主机购买者的地理位置信息和MAC地址之间的关系映射建立起来，可主机售出以后不仅可以被随意转卖，而且购买者本人也可以任意移动 - 今天在中国，明天在日本，因此想要通过MAC地址来实现定位功能，根本就无从谈起。

而IP地址不同，IP地址实际上是运营商的资产，那么分配机制自然也是由运营商确定的。运营商为了方便管理往往会将IP地址与地理位置关联起来 - 将连续的地址分配给一个区域的设备，相比随机分配的方式而言，管理起来更加方便。与此同时，运营商是网络服务的提供者，用户想要上网必须从它那里申请一个与地理位置强相关的IP地址才行，也就是说，相较于MAC地址，IP地址能够呈现出更强的地域性规律。

其实总结下来无外乎这一点：MAC地址是自己上报的，IP地址是运营商下发的。

MAC地址的路由表会被撑爆的
由于MAC地址分布的随机性，我们不能对其实现那种类似子网划分和路由聚合的功能，这意味着什么呢？意味着如果我们直接采用MAC地址来进行网络通信的话，寻址方式只能是这样：在全网范围内一台一台地搜索目的主机，而非像IP地址那样基于分层的寻址方式 - 通过比对路由表找到目的主机所在的网络后，再借由网关在局域网中寻址目的主机。

IP地址的路由表中存储的仅仅是网络号而已，可MAC地址的路由表中却不得不存储海量的主机地址，不被撑爆还有天理吗？

** MAC地址仅工作在数据链路层

这一点其实才是最核心的原因，前面说的几个原因都是由于MAC地址的设计定位才出现的。举个栗子，这就好像在问菜刀为什么不能被用来当兵器一样，攻击距离太短、太过笨重、不够灵活什么的说了一大堆，其实最主要的原因还是，IP地址和MAC地址自设计之初，就是为了解决不同的问题而诞生的：

MAC地址工作在数据链路层，其意义是本地网络中标识不同的主机，配置网络环境的时候，要注意同一本地网络中的两台主机之间的MAC地址不能撞车，否则就不能实现正常通信。

IP地址工作在网络层，用于在全球网络范围内标识不同的主机，由运营商负责发放，没有重复的可能，无需担心地址撞车问题。

** 为什么仅工作在数据链路层？

前面说了MAC地址仅工作在数据链路层，可为什么呢？现在的网络架构，我觉得说白了就是两个词，分层模型和存储转发，下面就从这两个角度分析一下吧。假设主机A在以下网络拓朴中向主机B发送数据，你以为的数据传输路线是这样的：


可实际上的数据传输路线是这样的：


确实，不太懂网络的人很容易会以为数据就是从源主机A根据IP寻址后直接抵达目的主机B的，其实不然，在计算机网络中传输数据，其实都是通过一个个中间网络的转发才能够抵达目的主机B的。在上述网络拓扑中，其实每个接口都是有IP地址的，只不过被我隐藏了，目的是突出数据在中间网络中的传输方式是以MAC帧的形式广播的。

简单分析一下第 2 张图：源主机A想要发送数据给目的主机B，需要将ipA和ipB分别封装到IP数据报的源地址和目的地址中，接着将macA和macC1分别封装到mac帧的源地址和目的地址中广播发送给macC1，macC1收到mac帧后，去掉帧首部得到数据报，经过路由寻址后发现应该把数据报从macC2封装成帧后广播发送给macD1，macD1收到数据报后，经过路由寻址后发现目的网络已经是可到达的了，于是将数据报交给macD2，macD2则继续封装成帧广播发送给macB，至此传输就结束了。

可以看到，在网络上数据的传输就像接力赛一样，IP数据报就像运动员手里的接力棒一样，是一成不变的，只要它定好了目的地址，运动员们就会通过两两之间的交接棒来帮助IP数据报交付到目的地址。
